<h2>–ö–æ–º–∞–Ω–¥–∞: {{ team.name }}</h2>
<p>–°—Ç–∞—Ä—Ç–∞–ø: {{ team.startup.name }}</p>

<h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
<ul>
  {% for membership in members %}
    <li>
      {{ membership.user.username }}
      {% if membership.role %}
        <span style="background-color: #e0e0e0; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">
          {{ membership.role.name }}
        </span>
      {% endif %}
      
      {% if membership.is_captain %} ‚≠ê –ö–∞–ø–∏—Ç–∞–Ω{% endif %}
      
      {% if is_founder or is_captain %}
        {% if membership.user != user %}
          ‚Äî <a href="{% url 'tasks:remove_member' team.id membership.user.id %}">–£–¥–∞–ª–∏—Ç—å</a>
        {% endif %}
      {% endif %}
    </li>
  {% endfor %}
</ul>

{% if is_founder or is_captain %}
<form method="post" action="{% url 'tasks:add_member' team.id %}">
  {% csrf_token %}
  <label for="user_id">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞:</label>
  <select name="user_id" required>
    {% for u in all_users %}
      {% if u.id not in current_users %}
        <option value="{{ u.id }}">{{ u.username }}</option>
      {% endif %}
    {% endfor %}
  </select>

  <label for="role_name">–†–æ–ª—å (–≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é):</label>
  <input type="text" name="role_name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–∏–∑–∞–π–Ω–µ—Ä">
  <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>
{% endif %}

{% if not is_founder and not is_captain %}
  <p><a href="{% url 'tasks:leave_team' team.id %}">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–∞–Ω–¥—É</a></p>
{% endif %}

<hr>
<h3>–§–∏–ª—å—Ç—Ä –∑–∞–¥–∞—á:</h3>
<form method="get">
  {{ form.as_p }}
  <button type="submit">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</form>

<h3>–ó–∞–¥–∞—á–∏:</h3>
<ul>
  {% for task in tasks %}
    <li style="{% if task.is_overdue %}color: red;{% endif %}">
        <strong>
          <a href="{% url 'tasks:task_detail' task.id %}">
            {{ task.title }}
          </a>
        </strong> ‚Äî      
      {% if task.is_completed %}
        ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
      {% else %}
        ‚ùå –í –ø—Ä–æ—Ü–µ—Å—Å–µ
      {% endif %}
      <br>
      –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ task.get_priority_display|default:"-" }}<br>
      {% if task.due_date %}
        –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y H:i" }}{% if task.is_overdue %} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ){% endif %}
      {% endif %}
      <br>
      –ù–∞–∑–Ω–∞—á–µ–Ω–æ: {{ task.assigned_to.username|default:"–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" }}
      <br>

      {% if user == task.assigned_to or is_captain or is_founder %}
        <a href="{% url 'tasks:toggle_task_complete' task.id %}">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</a>
      {% endif %}

      {% if user == task.created_by or is_captain or is_founder %}
        | <a href="{% url 'tasks:edit_task' task.id %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        | <a href="{% url 'tasks:delete_task' task.id %}">–£–¥–∞–ª–∏—Ç—å</a>
        | <a href="{% url 'tasks:archive_task' task.id %}">–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å</a>  {# üëà –¥–æ–±–∞–≤—å —ç—Ç–æ #}
      {% endif %}


    </li>
  {% empty %}
    <li>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.</li>
  {% endfor %}
</ul>

{% if is_captain or is_founder %}
  <p><a href="{% url 'tasks:create_task' team.id %}">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</a></p>
  <a href="{% url 'tasks:archived_tasks' team.id %}">üì¶ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</a>
{% endif %}
{% if is_founder or is_captain %}
  <p>
    <a href="{% url 'tasks:archive_completed' team.id %}" 
       onclick="return confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')">üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</a>
  </p>
{% endif %}

<hr>

{% if is_founder or is_captain %}
  <form method="post" action="{% url 'tasks:delete_team' team.id %}">
    {% csrf_token %}
    <button type="submit" onclick="return confirm('–¢—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Ö–æ—á–µ—à—å —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –∏ –≤—Å–µ –∑–∞–¥–∞—á–∏?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
  </form>
{% endif %}

<h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á</h3>
<ul>
  <li>–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {{ total_tasks }}</li>
  <li>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed_tasks }} ({{ completed_percent }}%)</li>
  <li>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ overdue_tasks }}</li>
</ul>

<canvas id="progressChart" width="300" height="300" style="max-width: 300px; max-height: 300px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const completed = {{ completed_tasks }};
    const overdue = {{ overdue_tasks }};
    const total = {{ total_tasks }};
    const incomplete = total - completed;

    const adjustedIncomplete = Math.max(0, incomplete - overdue);

    const ctx = document.getElementById('progressChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'],
          datasets: [{
            data: [completed, adjustedIncomplete, overdue],
            backgroundColor: ['#4CAF50', '#FF9800', '#F44336']  // –∑–µ–ª—ë–Ω—ã–π, –æ—Ä–∞–Ω–∂–µ–≤—ã–π, –∫—Ä–∞—Å–Ω—ã–π
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: '–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á'
            }
          }
        }
      });
    } else {
      console.warn("–≠–ª–µ–º–µ–Ω—Ç #progressChart –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM.");
    }
  });
</script>



<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π FullCalendar -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet" />

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript –¥–ª—è FullCalendar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>

<h3>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á</h3>
<div id="taskCalendar" style="max-width: 50%; margin: 20px 0; height: 300px;"></div>

<script>
  $(document).ready(function() {
    const tasks = {{ calendar_tasks_json|safe }};  // –ü–æ–¥—Å—Ç–∞–≤—å –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

    $('#taskCalendar').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay'
      },
      locale: 'ru',
      events: tasks
    });
  });
</script>
