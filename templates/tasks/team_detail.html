{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>{{ team.name }} ‚Äî –∫–æ–º–∞–Ω–¥–∞</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }

    h2, h3 {
      color: #f1f5f9;
      margin-bottom: 10px;
    }

    a {
      color: #60a5fa;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    ul {
      padding-left: 20px;
    }

    ul li {
      background-color: #1e293b;
      margin-bottom: 8px;
      padding: 10px 14px;
      border-radius: 8px;
    }

    .badge {
      background: #334155;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      color: #cbd5e1;
    }

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    select, input[type="text"] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #e2e8f0;
    }

    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #2563eb;
    }

    .task-status {
      font-size: 0.95em;
    }

    .task-overdue {
      color: #f87171;
    }

    .task-completed {
      color: #22c55e;
    }

    #progressChart {
      display: block;
      margin: 20px auto;
    }

    #taskCalendar {
      background-color: #1e293b;
      border-radius: 10px;
      padding: 10px;
      max-width: 600px;
      margin: 20px auto;
    }

    /* –ì–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #1e293b;
      padding: 10px 20px;
      border-radius: 0 0 10px 10px;
      margin-bottom: 20px;
      position: relative;
    }

    .header__logo {
       height: 100px;
       max-height: 70px;
       object-fit: contain;
       display: block;
}


    .logo {
      font-weight: 600;
      font-size: 1.3rem;
      color: #60a5fa;
      padding: 5px 0;
    }

    .hamburger {
      font-size: 1.8rem;
      cursor: pointer;
      user-select: none;
      color: #60a5fa;
      display: block;
    }

    nav.mobile-menu {
      display: none;
      flex-direction: column;
      position: absolute;
      top: 50px;
      right: 20px;
      background-color: #1e293b;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.3);
      z-index: 1000;
      min-width: 150px;
    }

    nav.mobile-menu a {
      color: #e2e8f0;
      padding: 10px 15px;
      text-decoration: none;
      border-bottom: 1px solid #334155;
    }

    nav.mobile-menu a:last-child {
      border-bottom: none;
    }

    nav.mobile-menu a:hover {
      background-color: #334155;
    }

    nav.mobile-menu.show {
      display: flex;
    }

    
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- FullCalendar -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js"></script>
</head>
<body>

<header class="main-header">
  <div class="logo">
    <img src="{% static 'images/logo5.png' %}" alt="–õ–æ–≥–æ—Ç–∏–ø MirecleHUB" class="header__logo" />
  </div>
  
  <div class="hamburger" id="hamburger">&#9776;</div>
  <nav class="mobile-menu" id="mobileMenu">
    <a href="{% url 'users:profile' %}">–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="{% url 'users:profile_edit' %}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    <a href="{% url 'startup:startup_list' %}">–°—Ç–∞—Ä—Ç–∞–ø—ã</a>
  </nav>
</header>

<h2>–ö–æ–º–∞–Ω–¥–∞: {{ team.name }}</h2>
<p>–°—Ç–∞—Ä—Ç–∞–ø: {{ team.startup.name }}</p>

<h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
<ul>
  {% for membership in members %}
    <li>
      {{ membership.user.username }}
      {% if membership.role %}
        <span class="badge">{{ membership.role.name }}</span>
      {% endif %}
      {% if membership.is_captain %} ‚≠ê –ö–∞–ø–∏—Ç–∞–Ω{% endif %}
      {% if is_founder or is_captain %}
        {% if membership.user != user %}
          ‚Äî <a href="{% url 'tasks:remove_member' team.id membership.user.id %}">–£–¥–∞–ª–∏—Ç—å</a>
        {% endif %}
      {% endif %}
    </li>
  {% endfor %}
</ul>

{% if is_founder or is_captain %}
<form method="post" action="{% url 'tasks:add_member' team.id %}" class="form-inline">
  {% csrf_token %}
  <select name="user_id" required>
    {% for u in all_users %}
      {% if u.id not in current_users %}
        <option value="{{ u.id }}">{{ u.username }}</option>
      {% endif %}
    {% endfor %}
  </select>

  <input type="text" name="role_name" placeholder="–†–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–∏–∑–∞–π–Ω–µ—Ä)" required>
  <button type="submit">‚ûï</button>
</form>
{% endif %}

{% if not is_founder and not is_captain %}
  <p><a href="{% url 'tasks:leave_team' team.id %}">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–∞–Ω–¥—É</a></p>
{% endif %}

<hr>
<h3>–§–∏–ª—å—Ç—Ä –∑–∞–¥–∞—á:</h3>
<form method="get">
  {{ form.as_p }}
  <button type="submit">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</form>

<h3>–ó–∞–¥–∞—á–∏:</h3>
<ul>
  {% for task in tasks %}
    <li class="{% if task.is_overdue %}task-overdue{% endif %}">
      <strong><a href="{% url 'tasks:task_detail' task.id %}">{{ task.title }}</a></strong> ‚Äî
      {% if task.is_completed %}
        <span class="task-status task-completed">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
      {% else %}
        <span class="task-status">‚ùå –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
      {% endif %}
      <br>
      –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ task.get_priority_display|default:"-" }}<br>
      {% if task.due_date %}
        –î–µ–¥–ª–∞–π–Ω: {{ task.due_date|date:"d.m.Y H:i" }}{% if task.is_overdue %} (–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ){% endif %}
      {% endif %}<br>
      –ù–∞–∑–Ω–∞—á–µ–Ω–æ: {{ task.assigned_to.username|default:"–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" }}<br>

      {% if user == task.assigned_to or is_captain or is_founder %}
        <a href="{% url 'tasks:toggle_task_complete' task.id %}">‚úÖ/‚ùå</a>
      {% endif %}
      {% if user == task.created_by or is_captain or is_founder %}
        | <a href="{% url 'tasks:edit_task' task.id %}">‚úèÔ∏è</a>
        | <a href="{% url 'tasks:delete_task' task.id %}">üóëÔ∏è</a>
        | <a href="{% url 'tasks:archive_task' task.id %}">üì¶</a>
      {% endif %}
    </li>
  {% empty %}
    <li>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.</li>
  {% endfor %}
</ul>

{% if is_captain or is_founder %}
  <p><a href="{% url 'tasks:create_task' team.id %}">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</a></p>
  <a href="{% url 'tasks:archived_tasks' team.id %}">üì¶ –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á</a>
  <p><a href="{% url 'tasks:archive_completed' team.id %}" onclick="return confirm('–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏?')">üì¶ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</a></p>
{% endif %}

<hr>
{% if is_founder or is_captain %}
  <form method="post" action="{% url 'tasks:delete_team' team.id %}">
    {% csrf_token %}
    <button type="submit" onclick="return confirm('–¢—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Ö–æ—á–µ—à—å —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –∏ –≤—Å–µ –∑–∞–¥–∞—á–∏?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
  </form>
{% endif %}

<h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á</h3>
<ul>
  <li>–í—Å–µ–≥–æ –∑–∞–¥–∞—á: {{ total_tasks }}</li>
  <li>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed_tasks }} ({{ completed_percent }}%)</li>
  <li>–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ: {{ overdue_tasks }}</li>
</ul>

<canvas id="progressChart" width="220" height="220"></canvas>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const completed = {{ completed_tasks }};
    const overdue = {{ overdue_tasks }};
    const total = {{ total_tasks }};
    const incomplete = total - completed - overdue;

    new Chart(document.getElementById('progressChart'), {
      type: 'doughnut',
      data: {
        labels: ['–í—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ'],
        datasets: [{
          data: [completed, incomplete, overdue],
          backgroundColor: ['#22c55e', '#f59e0b', '#ef4444']
        }]
      },
      options: {
        cutout: '70%',
        plugins: {
          legend: {
            labels: {
              color: '#cbd5e1',
              font: { size: 12 }
            }
          }
        }
      }
    });
  });
</script>

<h3>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á</h3>
<div id="taskCalendar"></div>
<script>
  $(document).ready(function () {
    const tasks = {{ calendar_tasks_json|safe }};
    $('#taskCalendar').fullCalendar({
      height: 350,
      contentHeight: 300,
      locale: 'ru',
      events: tasks,
      eventColor: '#3b82f6',
      header: {
        left: '',
        center: 'title',
        right: 'prev,next'
      }
    });
  });
</script>

<!-- JS –¥–ª—è –≥–∞–º–±—É—Ä–≥–µ—Ä–∞ -->
<script>
  document.getElementById('hamburger').addEventListener('click', function () {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('show');
  });
</script>

</body>
</html>
