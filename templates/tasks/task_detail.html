{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–∞–¥–∞—á–∞: {{ task.title }}</title>
  <style>
    body {
      background-color: #0a1124;
      color: #e0e6f7;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      line-height: 1.6;
      min-height: 100vh;
      margin: 0;
    }

    h2, h3, h4 {
      color: #ffffff;
      margin-top: 40px;
      margin-bottom: 20px;
    }

    p {
      max-width: 800px;
    }

    ul {
      padding-left: 0;
      list-style: none;
      max-width: 800px;
    }

    li {
      background-color: #1a2646;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }

    li.completed {
      text-decoration: line-through;
      opacity: 0.7;
    }

    a {
      color: #7fbfff;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    a:hover {
      color: #ffffff;
      text-decoration: underline;
    }

    form {
      margin-top: 12px;
      display: inline;
    }

    input, textarea, select {
      background-color: #121d38;
      color: #ffffff;
      border: none;
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      margin-top: 4px;
      margin-bottom: 16px;
      font-size: 14px;
      resize: vertical;
    }

    button {
      background-color: #3377ff;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 600;
      font-size: 14px;
    }

    button:hover {
      background-color: #265ed6;
    }

    .subtask-overdue {
      background-color: #512020;
      color: #ffb3b3;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
      font-size: 13px;
    }

    .comment {
      background-color: #141d3a;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 16px;
      border-left: 4px solid #345fff;
      max-width: 800px;
    }

    .activity-log li {
      font-size: 14px;
      margin-bottom: 8px;
      max-width: 800px;
    }

    .text-muted {
      color: #a0aac0;
      font-size: 12px;
    }

    .danger {
      color: #ff6666;
    }

    .subtask-actions button, .subtask-actions a {
      margin-left: 10px;
      font-size: 13px;
      vertical-align: middle;
    }

    .subtask-actions a.danger {
      color: #ff6666;
    }
  </style>
</head>
<body>

  

<h2>–ó–∞–¥–∞—á–∞: {{ task.title }}</h2>

<p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ task.description|linebreaks }}</p>
<p><strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> {{ task.get_priority_display }}</p>
<p><strong>–î–µ–¥–ª–∞–π–Ω:</strong> {{ task.due_date|date:"d.m.Y H:i" }}</p>
<p><strong>–ù–∞–∑–Ω–∞—á–µ–Ω–æ:</strong> {{ task.assigned_to.username|default:"–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" }}</p>

<hr>

<h3>üîπ –ü–æ–¥–∑–∞–¥–∞—á–∏</h3>
<ul>
  {% for sub in subtasks %}
    <li class="{% if sub.is_completed %}completed{% endif %}">
      <div style="flex:1; min-width: 250px;">
        <strong>{{ sub.title }}</strong> ‚Äî {{ sub.assigned_to.username|default:"–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" }}
        {% if sub.is_completed %} ‚úÖ {% else %} ‚ùå {% endif %}
        {% if sub.due_date %}
          <br>
          <strong>–î–µ–¥–ª–∞–π–Ω:</strong>
          <span class="{% if not sub.is_completed and sub.due_date < now %}subtask-overdue{% endif %}">
            {{ sub.due_date|date:"d.m.Y H:i" }}
          </span>
        {% endif %}
      </div>

      <div class="subtask-actions">
        <form method="post" action="{% url 'tasks:toggle_subtask' sub.id %}">
          {% csrf_token %}
          <button type="submit">
            {% if sub.is_completed %}–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É{% else %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% endif %}
          </button>
        </form>

        <a href="{% url 'tasks:edit_subtask' sub.id %}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">‚úèÔ∏è</a>
        <a href="{% url 'tasks:delete_subtask' sub.id %}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É?');" class="danger" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">üóëÔ∏è</a>
      </div>
    </li>
  {% empty %}
    <li>–ü–æ–¥–∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç.</li>
  {% endfor %}
</ul>

<h4>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É</h4>
<form method="post">
  {% csrf_token %}
  {{ subtask_form.as_p }}
  <button type="submit" name="add_subtask">–î–æ–±–∞–≤–∏—Ç—å</button>
</form>

<hr>

<h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
{% for comment in comments %}
  <div class="comment">
    <strong>{{ comment.author.username }}</strong> ‚Äî {{ comment.created_at|date:"d.m.Y H:i" }}<br>
    <p>{{ comment.text|linebreaks }}</p>
    {% if comment.file %}
      <a href="{{ comment.file.url }}" target="_blank">üìé –í–ª–æ–∂–µ–Ω–∏–µ</a>
    {% endif %}
  </div>
{% empty %}
  <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
{% endfor %}

<h4>‚úçÔ∏è –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" name="add_comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>

<hr>

<h3>üìú –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
<ul class="activity-log">
  {% for activity in activities %}
    <li>
      <strong>{{ activity.user.username }}</strong>
      {% if activity.action == 'created' %}
        —Å–æ–∑–¥–∞–ª(–∞) –∑–∞–¥–∞—á—É
      {% elif activity.action == 'edited' %}
        –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª(–∞) –∑–∞–¥–∞—á—É
      {% elif activity.action == 'completed' %}
        –≤—ã–ø–æ–ª–Ω–∏–ª(–∞) –∑–∞–¥–∞—á—É
      {% elif activity.action == 'reopened' %}
        –≤–æ–∑–æ–±–Ω–æ–≤–∏–ª(–∞) –∑–∞–¥–∞—á—É
      {% elif activity.action == 'commented' %}
        –æ—Å—Ç–∞–≤–∏–ª(–∞) –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      {% elif activity.action == 'added_subtask' %}
        –¥–æ–±–∞–≤–∏–ª(–∞) –ø–æ–¥–∑–∞–¥–∞—á—É: <em>"{{ activity.subtask.title }}"</em>
      {% elif activity.action == 'edited_subtask' %}
        –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª(–∞) –ø–æ–¥–∑–∞–¥–∞—á—É: <em>"{{ activity.subtask.title }}"</em>
      {% elif activity.action == 'deleted_subtask' %}
        —É–¥–∞–ª–∏–ª(–∞) –ø–æ–¥–∑–∞–¥–∞—á—É
      {% elif activity.action == 'completed_subtask' %}
        –≤—ã–ø–æ–ª–Ω–∏–ª(–∞) –ø–æ–¥–∑–∞–¥–∞—á—É: <em>"{{ activity.subtask.title }}"</em>
      {% elif activity.action == 'reopened_subtask' %}
        –≤–æ–∑–æ–±–Ω–æ–≤–∏–ª(–∞) –ø–æ–¥–∑–∞–¥–∞—á—É: <em>"{{ activity.subtask.title }}"</em>
      {% elif activity.action == 'deleted' %}
        —É–¥–∞–ª–∏–ª(–∞) –∑–∞–¥–∞—á—É
      {% endif %}
      <small class="text-muted"> ‚Äî {{ activity.timestamp|date:"d.m.Y H:i" }}</small>
    </li>
  {% endfor %}
</ul>

<form method="post" action="{% url 'tasks:clear_activity' task.id %}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?');" style="max-width: 800px; margin-top: 20px;">
  {% csrf_token %}
  <button type="submit" class="danger">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
</form>

<p style="margin-top: 40px;">
  <a href="{% url 'tasks:team_detail' team.id %}">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–æ–º–∞–Ω–¥–µ</a>
</p>

</body>
</html>
